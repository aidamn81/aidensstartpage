<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>The Gothic Archive</title>
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/512/compass--v1.png">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --obsidian: #050505; --crimson: #7a0000; --gold: #8c7340; --text: #a19a89; }
        
        body {
            background-color: var(--obsidian);
            background-image: linear-gradient(rgba(0,0,0,0.97), rgba(0,0,0,0.97)), 
                              url('https://www.transparenttextures.com/patterns/dark-brick-wall.png');
            color: var(--text); font-family: 'Playfair Display', serif;
            margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 100px;
        }

        body.is-dragging-active { overflow: hidden; touch-action: none; }

        #top-shield { width: 100%; height: calc(115px + env(safe-area-inset-top, 0px)); flex-shrink: 0; }

        #top-controls { 
            width: 100%; padding: 15px 20px; display: flex; justify-content: space-between; 
            align-items: center; border-bottom: 1px solid #1a1a1a; background: #000; 
            box-sizing: border-box; position: fixed; top: 0; z-index: 3000;
            padding-top: env(safe-area-inset-top, 20px);
        }
        
        #archive-grid { 
            display: grid; padding: 10px; 
            grid-template-columns: repeat(auto-fill, 62px); 
            gap: 15px 2px; width: 100%; max-width: 1200px;
            justify-content: center; align-items: start; position: relative;
        }

        #admin-desk { 
            display: none; position: fixed; bottom: 20px; right: 20px; 
            z-index: 4000; padding: 15px; gap: 8px; flex-direction: column; 
            width: 260px; background: rgba(8, 8, 8, 0.95); border: 1px solid var(--gold); 
            box-shadow: 0 0 20px rgba(0,0,0,1);
        }

        .relic-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; cursor: pointer; user-select: none; }
        .relic-frame { width: 50px; height: 68px; position: relative; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .relic-frame::before {
            content: ""; position: absolute; top: -6px; left: -6px; right: -6px; bottom: -6px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 120'%3E%3Cellipse cx='50' cy='60' rx='40' ry='50' fill='none' stroke='%237a0000' stroke-width='4'/%3E%3Cellipse cx='50' cy='60' rx='36' ry='46' fill='none' stroke='%238c7340' stroke-width='2'/%3E%3C/svg%3E");
            background-size: contain; background-repeat: no-repeat; z-index: 5;
        }
        .relic-frame img { width: 42px; height: 58px; object-fit: cover; clip-path: ellipse(50% 50% at 50% 50%); filter: sepia(0.3); }
        .folder-icon { width: 47px; height: 64px; background: rgba(10, 10, 10, 0.95); border: 1.8px solid var(--crimson); outline: 1px solid var(--gold); outline-offset: -4px; display: flex; flex-direction: column; padding: 8px 4px; overflow: hidden; }
        .folder-preview-text { font-family: 'Cinzel', serif; font-size: 0.35rem; color: var(--gold); text-align: center; white-space: nowrap; overflow: hidden; border-bottom: 0.5px solid rgba(140, 115, 64, 0.2); }
        .relic-name { margin-top: 2px; font-family: 'Cinzel'; font-size: 0.6rem; color: var(--gold); text-align: center; max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        @keyframes wiggle { 0% { transform: rotate(-1.5deg); } 50% { transform: rotate(1.5deg); } 100% { transform: rotate(-1.5deg); } }
        .wiggle-mode .relic-wrapper:not(.is-dragging) { animation: wiggle 0.25s infinite; }
        .relic-wrapper.is-dragging { opacity: 0.8; transform: scale(1.2); z-index: 5000; position: fixed; pointer-events: none; }
        .relic-wrapper.placeholder { opacity: 0.1; }

        /* Oracle Styles */
        #time-widget { background: rgba(5, 5, 5, 0.95); border: 1px solid var(--gold); padding: 20px; width: 310px; font-family: 'Cinzel', serif; color: var(--gold); box-shadow: 0 0 30px #000; margin: 40px auto; text-align: center; }
        #saved-shelf { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px; justify-content: center; }
        .dest-chip { background: #111; border: 1px solid var(--gold); color: var(--gold); padding: 5px 10px; font-size: 0.6rem; cursor: pointer; text-transform: uppercase; }
        .input-group { margin-bottom: 12px; text-align: left; }
        .time-input { background: #000; border: 1px solid #333; color: #fff; padding: 12px; width: 100%; box-sizing: border-box; font-family: 'Playfair Display', serif; font-size: 0.9rem; }
        .calc-btn { background: var(--crimson); color: white; border: none; padding: 12px; width: 100%; cursor: pointer; font-family: 'Cinzel'; font-size: 0.75rem; margin-top: 10px; }
        #result-box { margin-top: 20px; padding: 15px; border: 1px dashed var(--crimson); background: rgba(122, 0, 0, 0.1); display: none; }
        .departure-time { font-size: 1.6rem; color: #fff; display: block; margin-top: 5px; }

        #context-menu, #move-menu { 
            display: none; position: fixed; z-index: 6000; background: #0a0a0a; 
            border: 1px solid var(--gold); padding: 5px; min-width: 160px; 
            max-height: 80vh; overflow-y: auto; box-shadow: 0 0 30px #000;
        }
        .menu-item { padding: 14px 20px; font-family: 'Cinzel'; font-size: 0.75rem; color: var(--gold); cursor: pointer; border-bottom: 1px solid #1a1a1a; }
        .toggle-btn { background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 8px 15px; font-family: 'Cinzel'; font-size: 0.7rem; cursor: pointer; }
    </style>
</head>
<body>

    <div id="top-controls">
        <div style="display:flex; align-items:center;">
            <button id="back-btn" class="toggle-btn" style="display:none; margin-right:10px;" onclick="goBack()">← Back</button>
            <span id="status-text" style="font-family:'Cinzel'; font-size:0.75rem; color:var(--gold);">Gothic Archive</span>
        </div>
        <button id="edit-toggle" class="toggle-btn">Edit Mode</button>
    </div>

    <div id="top-shield"></div>

    <section id="admin-desk">
        <input type="text" id="r-name" placeholder="Name" class="time-input">
        <input type="text" id="r-url" placeholder="URL" class="time-input">
        <select id="r-type" class="time-input"><option value="link">Relic (Link)</option><option value="folder">Folder</option></select>
        <input type="file" id="r-file" accept="image/*" class="time-input">
        <button id="r-save" class="calc-btn">Commemorate</button>
    </section>

    <main id="archive-grid"></main>
    <input type="file" id="relic-update-file" accept="image/*" style="display:none">

    <div id="time-widget">
        <div class="widget-title">The Departure Oracle</div>
        <div id="saved-shelf"></div>
        <div class="input-group">
            <label style="font-size:0.5rem">Work Start Time</label>
            <input type="time" id="work-start" class="time-input" value="09:00">
        </div>
        <div class="input-group">
            <label style="font-size:0.5rem">Destination Postcode</label>
            <input type="text" id="dest-address" class="time-input" placeholder="e.g. SE1 7PB">
            <button class="toggle-btn" style="width:100%; margin-top:5px; font-size:0.5rem" onclick="addSavedLocation()">+ Save to Shelf</button>
        </div>
        <div class="input-group">
            <label style="font-size:0.5rem">Journey Minutes</label>
            <input type="number" id="travel-time" class="time-input" value="45">
        </div>
        
        <div style="font-size: 0.55rem; color: var(--gold); margin-bottom: 10px; border: 1px solid #1a1a1a; padding: 5px;">
            Preparation Ritual: 1.5 Hours Included
        </div>

        <span style="font-size:0.7rem; text-decoration:underline; cursor:pointer; display:block; margin:15px 0" onclick="openCitymapper()">Open in Citymapper App →</span>
        <button class="calc-btn" onclick="calculateOracle()">Consult Oracle</button>
        
        <div id="result-box">
            <span style="font-size:0.55rem; text-transform:uppercase;">Wake / Prepare (90m prior):</span>
            <span id="prep-time" class="departure-time" style="color:var(--gold);">--:--</span>
            <hr style="border:0; border-top:1px solid #333; margin:10px 0;">
            <span style="font-size:0.55rem; text-transform:uppercase;">Leave Home:</span>
            <span id="leave-time" class="departure-time">--:--</span>
        </div>
    </div>

    <div id="context-menu">
        <div class="menu-item" onclick="menuAction('edit')">Rename / Edit</div>
        <div class="menu-item" onclick="triggerImageUpdate()">Update Image</div>
        <div class="menu-item" onclick="showMoveMenu()">Move To...</div>
        <div class="menu-item" onclick="menuAction('delete')" style="color:var(--crimson);">Purge (Delete)</div>
    </div>
    <div id="move-menu"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAuNbY1Xv_ZF3kJah20qqPBz-IiiMAR9gE",
            authDomain: "aidenstartpage.firebaseapp.com",
            databaseURL: "https://aidenstartpage-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "aidenstartpage",
            storageBucket: "aidenstartpage.firebasestorage.app",
            messagingSenderId: "984377659362",
            appId: "1:984377659362:web:8cfe5e14e129fcae3273bb"
        };
        firebase.initializeApp(firebaseConfig);
        const rtdb = firebase.database();
        const auth = firebase.auth();

        let isEditMode = false, selectedId = null, currentFolder = 'root', allRelics = {};
        let dragItem = null, ghostItem = null, startX, startY;

        window.onload = () => { loadRelics(); renderSavedShelf(); };

        function loadRelics() {
            rtdb.ref('relics').on('value', snap => {
                allRelics = snap.val() || {};
                const grid = document.getElementById('archive-grid');
                grid.innerHTML = '';
                const items = Object.keys(allRelics).filter(id => allRelics[id].parent === currentFolder)
                    .sort((a,b) => (allRelics[a].sortOrder || 0) - (allRelics[b].sortOrder || 0));

                items.forEach(id => {
                    const r = allRelics[id];
                    const wrap = document.createElement('div');
                    wrap.className = 'relic-wrapper'; wrap.dataset.id = id;
                    
                    if(r.type === 'folder') {
                        const kids = Object.values(allRelics).filter(item => item.parent === id);
                        let html = kids.slice(0,4).map(k => `<div class="folder-preview-text">${k.name}</div>`).join('');
                        wrap.innerHTML = `<div class="relic-frame folder-icon">${html}</div><span class="relic-name">${r.name}</span>`;
                    } else {
                        wrap.innerHTML = `<div class="relic-frame"><img src="${r.imgUrl || ''}"></div><span class="relic-name">${r.name}</span>`;
                    }

                    wrap.onpointerdown = (e) => {
                        if(!isEditMode) return;
                        startX = e.clientX; startY = e.clientY; window.longPressed = false;
                        window.pTimer = setTimeout(() => { window.longPressed = true; showContextMenu(e, id); }, 700);
                        dragItem = wrap; wrap.setPointerCapture(e.pointerId);
                    };

                    wrap.onpointermove = (e) => {
                        if(!dragItem || window.longPressed) return;
                        if(Math.hypot(e.clientX - startX, e.clientY - startY) > 10) {
                            clearTimeout(window.pTimer);
                            document.body.classList.add('is-dragging-active');
                            if(!ghostItem) {
                                ghostItem = dragItem.cloneNode(true); ghostItem.classList.add('is-dragging');
                                dragItem.classList.add('placeholder'); document.body.appendChild(ghostItem);
                            }
                            ghostItem.style.left = `${e.clientX - 25}px`; ghostItem.style.top = `${e.clientY - 34}px`;
                            const target = document.elementsFromPoint(e.clientX, e.clientY).find(el => el.classList.contains('relic-wrapper') && el !== dragItem && el !== ghostItem);
                            if(target) reorder(dragItem.dataset.id, target.dataset.id);
                        }
                    };

                    wrap.onpointerup = (e) => {
                        clearTimeout(window.pTimer);
                        document.body.classList.remove('is-dragging-active');
                        if(ghostItem) { ghostItem.remove(); ghostItem = null; dragItem.classList.remove('placeholder'); }
                        else if(!window.longPressed) {
                            if(r.type === 'folder') enterFolder(id, r.name);
                            else if(r.url) window.open(r.url, '_blank');
                        }
                        dragItem = null;
                    };
                    grid.appendChild(wrap);
                });
            });
        }

        async function reorder(sid, tid) {
            const siblings = Object.keys(allRelics).filter(id => allRelics[id].parent === currentFolder).sort((a,b) => (allRelics[a].sortOrder||0)-(allRelics[b].sortOrder||0));
            const from = siblings.indexOf(sid), to = siblings.indexOf(tid);
            siblings.splice(from, 1); siblings.splice(to, 0, sid);
            const updates = {}; siblings.forEach((id, i) => { updates[`relics/${id}/sortOrder`] = i; });
            await rtdb.ref().update(updates);
        }

        function enterFolder(id, name) { currentFolder = id; document.getElementById('status-text').innerText = name; document.getElementById('back-btn').style.display = 'block'; loadRelics(); }
        function goBack() { currentFolder = 'root'; document.getElementById('status-text').innerText = "Gothic Archive"; document.getElementById('back-btn').style.display = 'none'; loadRelics(); }

        function triggerImageUpdate() { document.getElementById('relic-update-file').click(); document.getElementById('context-menu').style.display = 'none'; }
        document.getElementById('relic-update-file').onchange = (e) => {
            const file = e.target.files[0]; if(!file || !selectedId) return;
            const reader = new FileReader(); reader.onload = (ev) => { rtdb.ref('relics/' + selectedId).update({ imgUrl: ev.target.result }); };
            reader.readAsDataURL(file);
        };

        function showContextMenu(e, id) {
            selectedId = id; const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            let posX = e.clientX, posY = e.clientY;
            if (posY + 250 > window.innerHeight) posY = posY - 250;
            if (posX + 160 > window.innerWidth) posX = window.innerWidth - 170;
            menu.style.left = posX + 'px'; menu.style.top = posY + 'px';
        }

        document.getElementById('edit-toggle').onclick = (e) => {
            isEditMode = !isEditMode; document.body.classList.toggle('wiggle-mode', isEditMode);
            e.target.innerText = isEditMode ? "Lock Archive" : "Edit Mode";
            document.getElementById('admin-desk').style.display = isEditMode ? 'flex' : 'none';
            if(isEditMode && !auth.currentUser) auth.signInAnonymously();
        };

        document.getElementById('r-save').onclick = async () => {
            const n = document.getElementById('r-name').value, u = document.getElementById('r-url').value, t = document.getElementById('r-type').value, f = document.getElementById('r-file').files[0];
            if(!n) return;
            const push = (img) => { rtdb.ref('relics').push({ name: n, url: u, type: t, imgUrl: img || '', parent: currentFolder, sortOrder: 999 }); document.getElementById('r-name').value = ''; document.getElementById('r-url').value = ''; };
            if(f) { const r = new FileReader(); r.onload = (e) => push(e.target.result); r.readAsDataURL(f); } else push("");
        };

        function menuAction(action) {
            if(action === 'delete' && confirm("Purge this relic?")) rtdb.ref('relics/'+selectedId).remove();
            if(action === 'edit') { const n = prompt("New Name:", allRelics[selectedId].name); if(n) rtdb.ref('relics/'+selectedId).update({name: n}); }
            document.getElementById('context-menu').style.display = 'none';
        }

        function showMoveMenu() {
            const m = document.getElementById('move-menu'); m.innerHTML = '<div class="menu-item" onclick="executeMove(\'root\')">Move to Root</div>';
            Object.keys(allRelics).forEach(id => { if(allRelics[id].type === 'folder' && id !== selectedId) m.innerHTML += `<div class="menu-item" onclick="executeMove('${id}')">Move to ${allRelics[id].name}</div>`; });
            m.style.display = 'block'; m.style.left = document.getElementById('context-menu').style.left; m.style.top = document.getElementById('context-menu').style.top;
            document.getElementById('context-menu').style.display = 'none';
        }
        function executeMove(tid) { rtdb.ref('relics/'+selectedId).update({parent: tid}); document.getElementById('move-menu').style.display = 'none'; }

        // --- UPDATED ORACLE CALCULATION ---
        async function openCitymapper() {
            const dest = document.getElementById('dest-address').value; if(!dest) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dest)}`);
                const data = await res.json();
                const url = data.length > 0 ? `citymapper://directions?endcoord=${data[0].lat},${data[0].lon}&endname=${encodeURIComponent(dest)}` : `citymapper://directions?endaddress=${encodeURIComponent(dest)}`;
                window.location.href = url;
            } catch(e) { window.location.href = `citymapper://directions?endaddress=${encodeURIComponent(dest)}`; }
        }
        function addSavedLocation() {
            const dest = document.getElementById('dest-address').value; if(!dest) return;
            let saved = JSON.parse(localStorage.getItem('gothic_dests') || '[]');
            if(!saved.includes(dest)) { saved.push(dest); localStorage.setItem('gothic_dests', JSON.stringify(saved)); renderSavedShelf(); }
        }
        function renderSavedShelf() {
            const shelf = document.getElementById('saved-shelf'); shelf.innerHTML = '';
            const saved = JSON.parse(localStorage.getItem('gothic_dests') || '[]');
            saved.forEach(loc => {
                const chip = document.createElement('div'); chip.className = 'dest-chip'; chip.innerText = loc;
                chip.onclick = () => document.getElementById('dest-address').value = loc;
                chip.oncontextmenu = (e) => { e.preventDefault(); removeLoc(loc); };
                shelf.appendChild(chip);
            });
        }
        function removeLoc(loc) { let s = JSON.parse(localStorage.getItem('gothic_dests')).filter(i => i !== loc); localStorage.setItem('gothic_dests', JSON.stringify(s)); renderSavedShelf(); }
        
        function calculateOracle() {
            const start = document.getElementById('work-start').value;
            const travel = parseInt(document.getElementById('travel-time').value) || 0;
            if(!start) return;

            const [h, m] = start.split(':').map(Number);
            let d = new Date();
            d.setHours(h, m, 0, 0);

            // Subtract Travel Time to get "Leave Home"
            d.setMinutes(d.getMinutes() - travel);
            document.getElementById('leave-time').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});

            // Subtract 90 minutes (1.5 hours) for "Wake/Prepare"
            d.setMinutes(d.getMinutes() - 90);
            document.getElementById('prep-time').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});

            document.getElementById('result-box').style.display = 'block';
        }

        window.onclick = (e) => { if(!e.target.closest('.menu-item')) { document.getElementById('context-menu').style.display='none'; document.getElementById('move-menu').style.display='none'; } };
    </script>
</body>
</html>
