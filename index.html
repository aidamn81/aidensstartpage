<script>
    // ... (Keep your Firebase Config and Init) ...

    async function openCitymapper() {
        const destInput = document.getElementById('dest-address').value;
        if (!destInput) { alert("Enter a destination first."); return; }

        // Step 1: Resolve Address to Coordinates using OpenStreetMap (Free/No Key)
        // This ensures the App sees a "Physical Spot" rather than just text
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destInput)}`);
            const data = await response.json();

            let url;
            if (data && data.length > 0) {
                const lat = data[0].lat;
                const lon = data[0].lon;
                // Deep link using coordinates (The most reliable method for the App)
                url = `citymapper://directions?endcoord=${lat},${lon}&endname=${encodeURIComponent(destInput)}`;
            } else {
                // Fallback to text if search fails
                url = `citymapper://directions?endaddress=${encodeURIComponent(destInput)}`;
            }

            // Step 2: Try to launch App
            window.location.href = url;

            // Step 3: Web Fallback
            setTimeout(() => {
                if (document.visibilityState === 'visible') {
                    const webUrl = `https://citymapper.com/directions?endaddress=${encodeURIComponent(destInput)}`;
                    window.open(webUrl, '_blank');
                }
            }, 1000);

        } catch (error) {
            console.error("Geocoding failed", error);
            // Instant fallback if the coordinate search fails
            window.location.href = `citymapper://directions?endaddress=${encodeURIComponent(destInput)}`;
        }
    }

    // ... (Rest of your script for saving and calculating) ...
</script>

